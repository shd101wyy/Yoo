<html>
    <head>
        <title> Yoo </title>
        <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">

        <link rel="stylesheet" type="text/css" href="css/yiyi.css">
        <link rel="stylesheet" type="text/css" href="css/yoo.css">
        <link rel="stylesheet" href="https://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">


        <!-- identicon -->
        <script src="js/pnglib.js"></script>
        <script src="js/identicon.js"></script>
        <!-- *********** -->

        <script src="js/jquery.min.js"></script>
        <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
        <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    </head>

    <body>
        <!-- main page -->
        <div class="page" id="yoo_page">
            <div class="bar-header color-green">
                <h2 class="title" id="username_title">
                    User
                </h2>
            </div>
            <div class="content">
                <div class="list" id="yoo_card_list">
                    <div class="list-item card">
                        <p id="lon_lat"></p>
                    </div>
                    <!--
                    <div class="list-item card">
                        <p class="post_user"> shd101wyy: </p>
                        <p> Hello </p>
                    </div>
                    <div class="list-item card">
                        What's up
                    </div>
                    -->
                </div>
            </div>
            <div class="bar-footer color-green">
                <button id="yoo_btn" class="color-blue"> Yoo </button>
            </div>
        </div>

        <!-- user's profile page -->
        <div class="page" id="user_profile_page">
            <div class="bar-header color-white-transparent" id="profile_page_header">
                <!-- <div class="bar-element-left">
                    <i class="fa fa-chevron-left icon"> </i>
                </div>
                <h2 class="title" id="profile_user_title">
                    Profile: User
                </h2>
                -->
                <div class="grid-5-1">
                    <div class="grid-5-1-element">
                        <i class="fa fa-chevron-left" style="display: table-cell; vertical-align: middle;"> </i>
                    </div>
                    <div class="grid-5-1-element"> <br>  </div>
                    <div class="grid-5-1-element"> <br> </div>
                    <div class="grid-5-1-element"> <br> </div>
                    <div class="grid-5-1-element"> <br> </div>
                </div>
            </div>
            <div id="profile_content">
                <div id="profile_wall"> <!-- profile wall height 250px -->
                    <!-- Profile wall image -->
                    <img id="profile_wall_image" src="images/default_profile_wall.jpg">
                    <!-- update profile image -->
                    <input type="file" id="profile_wall_image_input" accept="image/*" style="display:none;" capture>

                    <!-- Profile image -->
                    <img id="profile_image" width=80 height=80>
                    <!-- update profile image -->
                    <input type="file" id="profile_image_input" accept="image/*" style="display:none;" capture>

                    <p id="profile_username"> shd101wyy </p>
                    <div class="grid-3-1" style="position: relative; height: 42px; background: rgba(234, 234, 234, 0.8); top: 30px; color: #838383; font-size: 13px;">
                        <div class="grid-3-1-element"> <p class="center">Profile<p> </div>
                        <div class="grid-3-1-element"> <p class="center">Posts</p> </div>
                        <div class="grid-3-1-element"> <p class="center"> Passby </p> </div>
                    </div>
                </div>

                <!-- User check and edit profile information  -->
                <div id="profile_information_content">
                    <div class="list" id="profile_information_content_list">
                        <div class="list-item profile_information_list_item" id="profile_intro_item">
                            <strong> Intro: </strong>
                            <p id="profile_intro"> This is the introduction, from where user can change his/her introduction. So the next time this user meets another user, they will send introduction to each other </p>
                        </div>
                        <div class="list-item profile_information_list_item" style="padding-bottom: 25px;">
                            <strong style="float:left;"> Age: </strong>
                            <p id="profile_age" style="float:right; "> show user's age here by calculation </p>
                        </div>
                        <div class="list-item profile_information_list_item" style="padding-bottom: 25px;" id="profile_gender_item">
                            <strong style="float:left;"> Gender: </strong>
                            <p id="profile_gender" style="float:right; "> tap me to change your gender here </p>
                        </div>
                        <div class="list-item profile_information_list_item" id="profile_location_item">
                            <strong > Location: </strong>
                            <p id="profile_location"> tap me to change your location here </p>
                        </div>
                        <div class="list-item profile_information_list_item" style="padding-bottom: 25px;" id="profile_birthday_item">
                            <strong style="float:left;"> Birthday: </strong>
                            <p id="profile_birthday" style="float:right; "> tap me to edit your birthday here </p>
                        </div>
                        <div class="list-item profile_information_list_item">
                            <strong > This is a test:(delete in the future) </strong>
                            <textarea class="profile_input" placeholder="Memeda"></textarea>
                        </div>
                        <div class="list-item profile_information_list_item" style="padding-bottom: 25px;">
                            <strong> Support other profile information in the future... </strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- user modify intro -->
            <div class="bottom-panel" id="modify_intro_panel" style="display:none;">
                <textarea id="profile_intro_input" placeholder="Enter your intro here"></textarea>
                <div id="modify_intro_panel_btn_group">
                    <p id="profile_intro_modify_submit"> Sumbit </p>
                    <p id="cancel_profile_intro_modify"> Cancel </p>
                </div>
            </div>

            <!-- user modify location -->
            <div class="bottom-panel" id="modify_location_panel" style="display:none;">
                <input id="profile_location_input" placeholder="Enter your location here"></input>
                <div id="modify_intro_panel_btn_group">
                    <p id="profile_location_modify_submit"> Sumbit </p>
                    <p id="cancel_profile_location_modify"> Cancel </p>
                </div>
            </div>

            <!-- user modify gender -->
            <div class="bottom-panel" id="modify_gender_panel" style="display:none;">
                <div id="modify_gender_panel_btn_group">
                    <strong> Choose your gender here :</strong> <br>
                    <p id="profile_gender_modify_male"> Male </p>
                    <p id="profile_gender_modify_male"> Female </p>
                    <p id="cancel_profile_gender_modify"> Cancel </p>
                </div>
            </div>

            <!-- user modify birthday -->
            <div class="bottom-panel" id="modify_birthday_panel" style="display:none;">
                <strong> Choose your birthday date here :</strong> <br>
                <input id="profile_birthday_input" type="date">
                <div id="modify_birthday_panel_btn_group">
                    <p id="profile_birthday_modify_submit"> Submit </p>
                    <p id="cancel_profile_birthday_modify"> Cancel </p>
                </div>
            </div>
        </div>


        <!-- other user's profile page  -->
        <div class="page" id="others_profile_page">
            <div class="bar-header color-blue">
                <button class="left color-blue back_btn_from_profile_page"> Back </button>
                <h2 class="title" id="profile_others_users_title">
                    Profile: Others
                </h2>
            </div>
            <div class="content">
                <p> TODO: Show other user's profile here. </p>
                <!--<button class="color-black" id="enter_chat_btn">
                    Chat
                </button>-->
            </div>
            <div class="bar-footer color-blue">
            </div>
        </div>

        <!-- Chat page -->
        <div class="page" id="chat_page">
            <div class="bar-header color-blue">
                <button class="left color-blue" id="back_btn_from_chat_page"> Back </button>
                <h2 class="title" id="chat_other_users_title">
                    Chat: Others
                </h2>
            </div>
        </div>

    </body>
    <script>

    // global variables
    window.longitude = null;
    window.latitude = null;
    window.socket = null;
    window.username = null;
    window.user_id = null;
    /**
     * Parse URL parameters and return a JSON data
     */
    function parseURLParameters() {
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        var output = {};
        for (var i=0; i < vars.length; i++) {
            var pair = vars[i].split("=");
            output[pair[0]] = pair[1];
        }
        return output;
    }

    // round lon/lat to integer => region
    function calculateRegion(degree) {
        return parseInt(degree * 100);
    }

    // calculate distance between 2 points
    function calculateDistance(lon1, lat1, lon2, lat2) {
        var R = 6371 * 1000; // m
        var phi1 = lat1 / 180 * Math.PI;
        var phi2 = lat2 / 180 * Math.PI;
        var delta_phi = (lat2 - lat1) / 180 * Math.PI;
        var delta_lambda = (lon2 - lon1) / 180 * Math.PI;
        var a = Math.sin(delta_phi / 2) * Math.sin(delta_phi / 2) +
            Math.cos(phi1) * Math.cos(phi2) *
            Math.sin(delta_lambda / 2) * Math.sin(delta_lambda / 2);
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        var d = R * c;
        return d;
    }

    // show location
    function showPosition(position) {
        // console.log(position);
        // First time init
        if(longitude === null && socket !== null){
            socket.emit("user_in_app", {longitude: position.coords.longitude,
                                                 latitude: position.coords.latitude,
                                                 lon_region: calculateRegion(position.coords.longitude),
                                                 lat_region : calculateRegion(position.coords.latitude),
                                                 username: username});
        }
        longitude = position.coords.longitude;
        latitude = position.coords.latitude;
        $("#lon_lat").text("Lon: " + longitude + "  Lat: " + latitude);
    }

    // geolocation reader error.
    function geolocationError(error) {
        switch (error.code) {
            case error.PERMISSION_DENIED:
                console.log("User denied the request for Geolocation.");
                break;
            case error.POSITION_UNAVAILABLE:
                console.log("Location information is unavailable.");
                break;
            case error.TIMEOUT:
                console.log("The request to get user location timed out.");
                break;
            case error.UNKNOWN_ERROR:
                console.log("An unknown error occurred.");
                break;
        }
    }

    $(document).ready(function(){
        socket = io(); // initialize socketio.
        var data = parseURLParameters();
        user_id = data.id;
        username = data.name;

        $("#username_title").text(username); // set username
        $("#profile_user_title").text(username); // set username


        /* */
        /* 这个一会儿删掉啊 */
       showProfile(username);


        // ###################################################

        // show main page
        $("#yoo_page").show();


        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(
                    showPosition,
                    geolocationError,
                    {
                        enableHighAccuracy: true, //,
                        //maximumAge: 0, //这两个iOS下不管用
                        timeout: 5000
                    });
            } else {
                alert("Geolocation is not supported.");
            }

        $("#yoo_btn").click(function(){
            socket.emit("user_update_location", {longitude: longitude,
                                                 latitude: latitude,
                                                 lon_region: calculateRegion(longitude),
                                                 lat_region : calculateRegion(latitude),
                                                 username: username});
        });

        // other users nearby
        socket.on("receive_user_yoo", function(data){
            /**
             * TODO: After user click the nearby user card, they can have a private chat. follow/unfollow
             * check profile wall
             *
             * <div class="list-item card">
             *   <p class="post_user"> shd101wyy: </p>
             *   <p> Hello </p>
             * </div>
             *
             */
            console.log("receive user info");
            var sender_name = data[0];
            var sender_status = data[1];
            var distance = data[2];
            var card = $("<div></div>").addClass("list-item card").empty();
            var card_poster = $("<p></p>").addClass("post_user").text(sender_name + ": ");
            var card_content = $("<p></p>").text(sender_status);
            card.append(card_poster);
            card.append(card_content);
            card.append("<p>distance(omit in future): " + distance + " </p>"); // dont show this in the future for privacy!

            // click user name => goto profile page
            card_poster.click(function(){
                gotoOthersProfilePage(sender_name);
            });

            $("#yoo_card_list").prepend(card); // append to top.
        });
        // send location to server every 15s
        //setInterval(function(){
        //}, 15000);
        //

        // go back to Yoo_page
        $(".back_btn_from_profile_page").click(function(){
            $(".page").hide();
            $("#yoo_page").toggle("slide", {direction: "left"}, 400);
        });

        // go back to others profile page
        $("#back_btn_from_chat_page").click(function(){
            $(".page").hide();
            $("#others_profile_page").toggle("slide", {direction: "left"}, 400);
        });

        // goto chat_page
        $("#enter_chat_btn").click(function(){
            $(".page").hide();
            $("#chat_page").show();
        });

        // goto user profile page
        $("#username_title").click(function(){
            $(".page").hide();
            $("#user_profile_page").show();

            // show identicon
            var data = new Identicon("shd101wyy", 420).toString();
            $("#profile_image").attr({"src": "data:image/png;base64," + data});
        });
    });
    </script>

    <script src="js/yoo.js"></script>
    <script src="js/profile.js"> </script>
</html>
